<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 매출, 채권 Mapper -->
<mapper namespace="com.cherp.app.acct.mapper.SalesMapper">
	<!-- 채권(receivable) 전체 조회 
	<select id="receivablesList" resultType="com.cherp.app.acct.vo.SalesVO">
		SELECT log_id, sales_chit_no, rec_date, decrease_price, bacct_code
		FROM receivables_log
	</select>-->
	
	<select id="receivablesList" resultType="com.cherp.app.acct.vo.SalesVO">
		SELECT
		    p.log_id,
		    p.sales_chit_no,
		    p.rec_date,
		    p.bacct_code,
		    p.client,
		    (
		        SELECT
		            client_name
		        FROM
		            client
		        WHERE
		            client_code = p.client
		    )             AS client_name,
		    s.rec_balance AS rec_balance,
		    s.rec_status  AS rec_status
		FROM
		         receivables_log p
		    JOIN sales s ON p.sales_chit_no = s.sales_chit_no
	</select>
	
	<select id="payablesList" resultType="com.cherp.app.acct.vo.PayablesVO">
		SELECT
		    p.rec_log_id,
		    p.purchase_chit_no,
		    p.rec_date,
		    p.bacct_code,
		    p.client,
		    (
		        SELECT
		            client_name
		        FROM
		            client
		        WHERE
		            client_code = p.client
		    )                  AS client_name,
		    s.decrease_balance AS decrease_balance,
		    s.decrease_status  AS decrease_status
		FROM
		         payables_log p
		    JOIN purchase s ON p.purchase_chit_no = s.purchase_chit_no
	</select>
	
	<select id="SelectAllClientPayableList" parameterType="com.cherp.app.acct.vo.ClientPsVO">
		SELECT *
		FROM   client
	</select>
	
	<!-- sales 테이블 insert(매출전표 등록) -->
	<insert id="insertSale" parameterType="com.cherp.app.acct.vo.SalesVO">
	<selectKey keyProperty="salesChitNo" order="BEFORE" resultType="string">
	    SELECT 'mk' || TO_CHAR(SYSDATE, 'YYYYMMDD') || 
	           LPAD(NVL(MAX(TO_NUMBER(SUBSTR(sales_chit_no, 10))), 0) + 1, 3, '0')
	    FROM sales
	    WHERE SUBSTR(sales_chit_no, 2, 8) = TO_CHAR(SYSDATE, 'YYYYMMDD')
	</selectKey>
		INSERT INTO sales (
                     sales_chit_no
           			 ,chit_date
           			 ,client
           			 ,acct_name
       			     ,supply_price
            		 ,vat
           		  	 ,total_price
           	 	 	 ,writer
           			 ,rec_balance
           		  	 ,rec_status
	       			 ,summary
           			 ,saleslip_no)
                    )
			  VALUES(
		           #{salesChitNo}
		          ,#{chitDate}
		          ,#{client}
		          ,#{acctName}
		          ,#{supplyPrice}
		          ,#{vat}
	              ,#{totalPrice}
	              ,#{writer}
                  ,#{recBalance}
                  ,#{recStatus}
                  ,#{summary}
                  ,#{saleslipNo}
		        )
	</insert>
	
	<!-- RECEIVABLES_LOG 테이블 insert(채권 거래 내역 등록)
	<insert id="insertReceivable">
		 INSERT INTO  receivables_log(
	            log_id
	            ,rec_date
	            ,increase_price
	            ,client
	            ,sales_chit_no
	        ) VALUES(
	           #{}
	           ,#{}
	           ,#{}
	           ,#{}
	           ,#{} 
	</insert> -->
    
    <!-- CLIENT(거래처) 테이블 BALANCEK(총 채권 잔액) 업데이트 
    <update id="updateClientBalancek"></update>-->
	
</mapper>