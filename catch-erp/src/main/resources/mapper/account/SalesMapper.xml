<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- 매출, 채권 Mapper -->
<mapper namespace="com.cherp.app.acct.mapper.SalesMapper">
	<!-- 채권(receivable) 전체 조회 -->
	<select id="receivablesList" resultType="com.cherp.app.acct.vo.SalesVO">
		SELECT log_id, sales_chit_no, rec_date, decrease_price, bacct_code
		FROM receivables_log
	</select>
	
	<select id="payablesList" resultType="com.cherp.app.acct.vo.SalesVO">
		SELECT  p.rec_log_id
        ,p.sales_chit_no
        ,p.rec_date
        ,p.bacct_code
        ,p.client
        ,(SELECT client_name
          FROM   client
          WHERE  client_code = p.client) as client_name
        ,s.rec_balance as rec_balance
        ,s.rec_status as rec_status
		FROM    payables_log p JOIN sales s
        ON p.sales_chit_no = s.sales_chit_no
	</select>
	
	<!-- sales 테이블 insert(매출전표 등록) -->
	<insert id="insertSales" parameterType="com.cherp.app.acct.vo.SalesVO">
	<selectKey keyProperty="salesChitNo" order="BEFORE" resultType="string">
	    SELECT 's' || TO_CHAR(SYSDATE, 'YYYYMMDD') || 
	           LPAD(NVL(MAX(TO_NUMBER(SUBSTR(sales_chit_no, 10))), 0) + 1, 3, '0')
	    FROM sales
	    WHERE SUBSTR(sales_chit_no, 2, 8) = TO_CHAR(SYSDATE, 'YYYYMMDD')
	</selectKey>
		INSERT INTO sales (
                     sales_chit_no -- 매출 전표 번호
           			 ,chit_date -- 전표 일자
           			 ,client -- 거래처
           			 ,acct_name --계정 과목
       			     ,supply_price -- 공급가액
            		 ,vat -- 부가세
           		  	 ,total_price -- 총금액
           	 	 	 ,writer -- 작성자
           			 ,rec_balance -- 채권잔액 = 총금액
           		  	 ,rec_status -- 지급상태
	       			 ,summary -- 적요
           			 ,saleslip_no) --판매전표 번호
                    )
			  VALUES(
		           #{salesChitNo}
		          ,#{chitDate}
		          ,#{client}
		          ,#{acctName}
		          ,#{supplyPrice}
		          ,#{vat}
	              ,#{totalPrice}
	              ,#{writer}
                  ,#{recBalance}
                  ,#{recStatus}
                  ,#{summary}
                  ,#{saleslipNo}
		        )
	</insert>
</mapper>