<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/account_layout}"
      layout:fragment="Content">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>채권감소등록</title>
  <link rel="tableStyle.css" />
  <style>
    .modal-header {
        background-color: #AACB73;
        color: white;
    }
    .modal-dialog {
        max-width: 800px;
    }
    .ledger-form {
        border: 2px solid #FF0000;
        margin: 1rem;
    }
    .ledger-title {
        background-color: #FFF;
        color: #FF0000;
        border: 1px solid #FF0000;
        padding: 0.5rem;
        text-align: center;
        font-weight: bold;
    }
    .ledger-table {
        font-size: 0.9rem;
    }
    .ledger-table th {
        background-color: #f8f9fa;
        text-align: center;
        vertical-align: middle;
    }
    .ledger-table td {
        vertical-align: middle;
    }
    .number-column {
        text-align: right;
        font-family: monospace;
    }
    .subtotal-row {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    .ledger-date-column {
        width: 90px;
    }
    .ledger-description-column {
        width: 120px;
    }
    .ledger-amount-column {
        width: 120px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="bg-white shadow-sm rounded" style="padding: 20px;">
    <!-- Search Section -->
    <div class="border-bottom pb-3 mb-4">
      <h2>채권감소등록</h2>
    </div>
    <div class="gridWrapper">
      <button type="button" class="btn btn-success" id="newAcc" data-bs-toggle="modal" data-bs-target="#accountSearchModal" style="margin-bottom: 10px;">입금등록(F2)</button>
      <div id="grid"></div>
      <div id="pagination" class="tui-pagination"></div> <!-- 페이징 ui -->
    </div>
    <!-- 모달 -->
    <div class="modal fade" id="accountSearchModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #aacb73;">
                <h5 class="modal-title" id="accountSearchModalLabel">계좌검색</h5>
            </div>
            <div class="modal-body">
              <div id="example-table"></div> <!-- modal tabulator 사용 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
      </div>
    </div>
    <!-- 거래처 원장 모달 -->
    <div class="modal fade" id="ledgerModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="width: 1200px;">
                <div class="modal-header">
                    <h5 class="modal-title">거래처원장</h5>                    
                </div>
                <div class="modal-body">
                    <div id="reportContent" class="ledger-form">
                        <div class="container-fluid p-4">
                            <div class="row mb-3">
                                <div class="col">
                                    <strong>거래처:</strong> 
                                </div>
                                <div class="col text-end">
                                    <strong>Page #</strong> 1
                                </div>
                            </div>
                            <table class="table table-bordered ledger-table">
                                <thead>
                                    <tr>
                                        <th class="ledger-date-column">일자</th>
                                        <th class="ledger-description-column">계정</th>
                                        <th>적요</th>
                                        <th class="ledger-amount-column">증감</th>
                                        <th class="ledger-amount-column">감소</th>
                                        <th class="ledger-amount-column">잔고</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>01-14</td>
                                        <td>미수금</td>
                                        <td>외화표-ESI 컴퍼니(302호)</td>
                                        <td class="number-column">950,000</td>
                                        <td class="number-column">0</td>
                                        <td class="number-column">-9,378,469</td>
                                    </tr>
                                    <tr>
                                        <td>01-21</td>
                                        <td>매수금(환거래)</td>
                                        <td>19년01월달 환거래금-개포3동</td>
                                        <td class="number-column">35,427</td>
                                        <td class="number-column"></td>
                                        <td class="number-column">-9,413,896</td>
                                    </tr>
                                    <tr class="subtotal-row">
                                        <td colspan="3">(누계)</td>
                                        <td class="number-column">-9,261,172</td>
                                        <td class="number-column">704,034</td>
                                        <td class="number-column"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="pdfButton">PDF 저장</button>
                </div>
            </div>
        </div>
    </div>
  </div>
  
  
  <script>
  //toast ui data값 입력(추후 db와 연결해서 값 출력해아함)
  document.addEventListener('DOMContentLoaded', function() {
	//JSON 로드
	fetch('http://localhost:8026/payList')
  	.then(result => result.json())
  	.then((result) => {
	    //grid 설정하기
	    //toast ui table 기본 틀 작성
	    const grid = new tui.Grid( { // 브라우저 환경에서 네임 스페이스 이용(new tui.Grid)
	      el: document.querySelector('#grid'),
	      data: result, // toast ui table 에 입력할 데이터값
	      scrollX: true,
	      scrollY: true, // 가로, 세로 스크롤 사용 유무 판단
	      pageOptions: {
	        useClient: true,
	        perPage: 5
	      },
	      rowHeaders: [
	          {
	            type: 'checkbox',
	            header: `
	              <span class="custom-input">
	              <input type="checkbox" id="all-checkbox" class="hidden-input" name="_checked" />
	            	<label for="all-checkbox" class="checkbox selectCheck">✔</label>
	          	</span>
	          `,
	            renderer: {
	              type: gridCheckbox
	            }
	          }
	    ],
	      columns: [
                  {
                      header: '거래처코드',
                      name: 'clientCode',
                      sortable: true,
                      filter: 'select',
                      align: 'center'
                  },
                  {
                      header: '거래처명',
                      name: 'clientName',
                      filter: 'select',
                      sortable: true,
                      align: 'left'
                  },
                  {
                      header: '거래처 계좌',
                      name: 'clientBacct',
                      filter: 'select',
                      sortable: true,
                      align: 'left'
                  },      
                  {
                      header: '잔액',
                      name: 'balancek',
                      sortable: true,
                      align: 'left'
                  },
                  {
                      header: '입금금액',
                      name: 'decreasePrice',
                      editor: 'text',
                      sortable: true,
                      align: 'left'
                  },
                  {
                    header: '채무상태',
                    name: 'state',
                    sortable: true,
                    align: 'left'
                  }
         ]
	  });
      grid.on('click', (event) => { // grid 클릭이벤트 발생
	        if(event.columnName === 'recLogId' && event.rowKey>=0) {
	          console.log("클릭이벤트 발생");
	          console.log(event.rowKey);
	          let ledgeModal = new bootstrap.Modal(document.querySelector('#ledgerModal'));
              ledgeModal.show();
        	}
      })
      // 계좌 목록 조회 모달
      fetch('http://localhost:8026/bacctList')
      .then(result => result.json())
      .then(accountList => {
        //Build Tabulator
        let accList = new Tabulator("#example-table", {
            layout:"fitColumns",
            pagination:"local",
            data: accountList,
            paginationSize:8,
            //paginationSizeSelector:[3, 6, 8, 10],
            movableColumns:true,
            paginationCounter:"rows",
            paginationCounter:function(pageSize, currentRow, currentPage, totalRows, totalPages){
                return "";
            },
            langs:{
                "default":{
                    "pagination":{
                        "first":"처음",
                        "first_title":"처음으로",
                        "last":"끝",
                        "last_title":"마지막으로",
                        "prev":"이전",
                        "prev_title":"이전으로",
                        "next":"다음",
                        "next_title":"다음으로",
                        "all":"전체",
                    }
                }
            },
            columns:[
                {title:"계좌번호", field:"bacctNo", width:220, sorter:"string", headerFilter:"input"},
                {title:"은행명", field:"bankName", width:220, sorter:"string", headerFilter:"input"},
                {title:"계좌명", field:"bacctName", width:330, sorter:"string", headerFilter:"input"},
            ],
        });
        accList.on("rowClick", function(event, row) {
          //alert("계좌 선택 이후 거래내역에 해당 계좌로 데이터 추가");
          //console.log(row.getData().bacctNo);
          Swal.fire({
            title: "결제하시겠습니까?",
            text: `계좌번호 : ${row.getData().bacctNo} 은행명: ${row.getData().bankName}`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "결제",
            cancelButtonText: "취소"
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire({
                title: "결제되었습니다",
                text: `계좌번호 : ${row.getData().bacctNo} 결제완료`,
                icon: "success",
                confirmButtonText: "완료"
              }).then((result => {
                if(result.isConfirmed) {
                  // 여기서 DB업데이트가 실행되어야함
                  // 채무거래 테이블
                  location.reload(true);
                }
              }))
            }
          });
        })
      })
  })
  .catch((error) => console.error("Error loading JSON:", error));

	 // 툴팁 초기화
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // 숫자 포맷팅
    document.querySelectorAll('.number-column').forEach(function (element) {
        const value = element.textContent;
        if (value && !isNaN(value.replace(/,/g, ''))) {
            element.textContent = Number(value.replace(/,/g, '')).toLocaleString('ko-KR');
        }
    });

    // PDF 저장 기능
    document.getElementById('pdfButton').addEventListener('click', function() {
        const element = document.getElementById('reportContent');
        html2canvas(element).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF();
            const imgProps = pdf.getImageProperties(imgData);
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
            pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('거래처원장.pdf');
        });
    });
  })
    
  </script>
</body>
</html>