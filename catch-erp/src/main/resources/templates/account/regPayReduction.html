<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/account_layout}"
      layout:fragment="Content">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>채권감소등록</title>
  <link rel="tableStyle.css" />
  <style>
    .modal-header {
        background-color: #AACB73;
        color: white;
    }
    .modal-dialog {
        max-width: 800px;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="bg-white shadow-sm rounded" style="padding: 20px;">
    <!-- Search Section -->
    <div class="border-bottom pb-3 mb-4">
      <h2>채권감소등록</h2>
    </div>
    <div class="gridWrapper">
      <button type="button" class="btn btn-success" id="newAcc" data-bs-toggle="modal" data-bs-target="#accountSearchModal" style="margin-bottom: 10px;">입금등록(F2)</button>
      <div id="grid"></div>
      <div id="pagination" class="tui-pagination"></div> <!-- 페이징 ui -->
    </div>
    <!-- 모달 -->
    <div class="modal fade" id="accountSearchModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #aacb73;">
                <h5 class="modal-title" id="accountSearchModalLabel">계좌검색</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="example-table"></div> <!-- modal tabulator 사용 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
      </div>
    </div>
    
  </div>
  
  
  <script>
  //toast ui data값 입력(추후 db와 연결해서 값 출력해아함)
  document.addEventListener('DOMContentLoaded', function() {
	//JSON 로드
	fetch('http://localhost:8026/payList')
  	.then(result => result.json())
  	.then((result) => {
	    //grid 설정하기
	    //toast ui table 기본 틀 작성
	    const grid = new tui.Grid( { // 브라우저 환경에서 네임 스페이스 이용(new tui.Grid)
	      el: document.querySelector('#grid'),
	      data: result, // toast ui table 에 입력할 데이터값
	      scrollX: true,
	      scrollY: true, // 가로, 세로 스크롤 사용 유무 판단
	      pageOptions: {
	        useClient: true,
	        perPage: 5
	      },
	      columns: [
                  {
                      header: '채권번호',
                      name: 'recLogId',
                      sortable: true,
                      filter: 'select',
                      align: 'center'
                  },
                  {
                      header: '발생일자',
                      name: 'recDate',
                      sortable: true,
                      align: 'left'
                  },
                  {
                      header: '거래처명',
                      name: 'clientName',
                      filter: 'select',
                      sortable: true,
                      align: 'left'
                  },
                  {
                      header: '계좌코드',
                      name: 'bacctCode',
                      filter: 'select',
                      sortable: true,
                      align: 'left'
                  },      
                  {
                      header: '잔액',
                      name: 'recBalance',
                      sortable: true,
                      align: 'left'
                  },
                  {
                      header: '입금금액',
                      name: 'decreasePrice',
                      editor: 'text',
                      sortable: true,
                      align: 'left'
                  },
                  {
                    header: '채무상태',
                    name: 'recStatus',
                    sortable: true,
                    align: 'left'
                  }
         ],
	     rowHeaders: ['rowNum', 'checkbox']// 테이블 좌측에 No와 체크박스를 나타냄
	  });
      grid.on('click', (event) => { // grid 클릭이벤트 발생
	        if(event.columnName === 'debentureNo' && event.rowKey>=0) {
	          console.log("클릭이벤트 발생");
	          console.log(event.rowKey);
        	}
      })
      // 계좌 목록 조회 모달
      fetch('http://localhost:8026/bacctList')
      .then(result => result.json())
      .then(accountList => {
        //Build Tabulator
        let accList = new Tabulator("#example-table", {
            layout:"fitColumns",
            pagination:"local",
            data: accountList,
            paginationSize:8,
            //paginationSizeSelector:[3, 6, 8, 10],
            movableColumns:true,
            paginationCounter:"rows",
            paginationCounter:function(pageSize, currentRow, currentPage, totalRows, totalPages){
                return "";
            },
            langs:{
                "default":{
                    "pagination":{
                        "first":"처음",
                        "first_title":"처음으로",
                        "last":"끝",
                        "last_title":"마지막으로",
                        "prev":"이전",
                        "prev_title":"이전으로",
                        "next":"다음",
                        "next_title":"다음으로",
                        "all":"전체",
                    }
                }
            },
            columns:[
                {title:"계좌번호", field:"bacctNo", width:220, sorter:"string", headerFilter:"input"},
                {title:"은행명", field:"bankName", width:220, sorter:"string", headerFilter:"input"},
                {title:"계좌명", field:"bacctName", width:330, sorter:"string", headerFilter:"input"},
            ],
        });
        accList.on("rowClick", function(event, row) {
          //alert("계좌 선택 이후 거래내역에 해당 계좌로 데이터 추가");
          //console.log(row.getData().bacctNo);
          Swal.fire({
            title: "결제하시겠습니까?",
            text: `계좌번호 : ${row.getData().bacctNo} 은행명: ${row.getData().bankName}`,
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "결제",
            cancelButtonText: "취소"
          }).then((result) => {
            if (result.isConfirmed) {
              Swal.fire({
                title: "결제되었습니다",
                text: `계좌번호 : ${row.getData().bacctNo} 결제완료`,
                icon: "success",
                confirmButtonText: "완료"
              }).then((result => {
                if(result.isConfirmed) {
                  // 여기서 DB업데이트가 실행되어야함
                  // 채무거래 테이블
                  location.reload(true);
                }
              }))
            }
          });
        })
      })
  })
  .catch((error) => console.error("Error loading JSON:", error));

  
  })
    
  </script>
</body>
</html>