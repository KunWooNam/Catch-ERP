<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/account_layout}"
      layout:fragment="Content">
<head>
  <meta charset="UTF-8" >
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>채무조회</title>
  <link rel="stylesheet" th:href="@{/css/sales/recReduction.css}"/>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="bg-white shadow-sm rounded" style="padding: 20px;">
    <!-- Search Section -->
    <div class="border-bottom pb-3 mb-4">
      <h2>채무감소등록</h2>
    </div>
    <div class="gridWrapper">
      <button type="button" class="btn btn-success" id="newAcc" data-bs-toggle="modal" data-bs-target="#accountSearchModal" style="margin-bottom: 10px;">입금등록</button>
      <div id="grid"></div>
      <div id="pagination" class="tui-pagination"></div> <!-- 페이징 ui -->
    </div>
    <!-- 모달 -->
    <div class="modal fade" id="accountSearchModal" tabindex="-1" aria-labelledby="modalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #aacb73;">
                <h5 class="modal-title" id="accountSearchModalLabel">계좌검색</h5>
            </div>
            <div class="modal-body">
              <div id="example-table"></div> <!-- modal tabulator 사용 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div>
      </div>
    </div>
    <!-- 거래처 원장 모달 -->
    <div class="modal fade" id="ledgerModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="width: 1200px;">
                <div class="modal-header">
                    <h5 class="modal-title">거래처원장</h5>                    
                </div>
                <div class="modal-body">
                    <div id="reportContent" class="ledger-form">
                        <div class="container-fluid p-4">
                            <div class="row mb-3">
                                <div class="col">
                                    <p id="payClientName"></p>
                                </div>
                                <div class="col text-end">
                                    <strong>Page #</strong> 1
                                </div>
                            </div>
                            <table class="table table-bordered ledger-table">
                                <thead>
                                    <tr>
                                        <th class="ledger-date-column">일자</th>
                                        <th class="ledger-description-column">계정</th>
                                        <th>적요</th>
                                        <th class="ledger-amount-column">증가</th>
                                        <th class="ledger-amount-column">감소</th>
                                        <th class="ledger-amount-column">잔고</th>
                                    </tr>
                                </thead>
                                <tbody id="ledgeBody">
                                    <!-- 거래처별 채무거래내역 -->
                                </tbody>
                                <tfoot class="ledge-footer">
                                  <tr>
                                    <td colspan="3" style="text-align: center; font-weight: bold; color: red; font-size: 15px;" >누계</td>
                                    <td id="totIncrease"></td>
                                    <td id="totDecrease"></td>
                                    <td id="totBalance"></td>
                                  </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                    <button type="button" class="btn btn-primary" id="pdfButton">PDF 저장</button>
                </div>
            </div>
        </div>
    </div>
  </div>
  
  
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      let grid;
      function makePayableGrid(result) {
        let makeGrid = new tui.Grid( { // 브라우저 환경에서 네임 스페이스 이용(new tui.Grid)
            el: document.querySelector('#grid'),
            data: result, // toast ui table 에 입력할 데이터값
            scrollX: true,
            scrollY: true, // 가로, 세로 스크롤 사용 유무 판단
            pageOptions: {
              useClient: true,
              perPage: 5
            },
            rowHeaders: [
                {
                  type: 'checkbox',
                  header: `
                    <span class="custom-input">
                    <input type="checkbox" id="all-checkbox" class="hidden-input" name="_checked" />
                    <label for="all-checkbox" class="checkbox selectCheck">✔</label>
                  </span>
                `,
                  renderer: {
                    type: gridCheckbox
                  }
                }
            ],
            columns: [
                      {
                          header: '거래처코드',
                          name: 'clientCode',
                          sortable: true,
                          filter: 'select',
                          align: 'center'
                      },
                      {
                          header: '거래처명',
                          name: 'clientName',
                          filter: 'select',
                          sortable: true,
                          align: 'left'
                      },
                      {
                          header: '거래처 계좌',
                          name: 'clientBacct',
                          filter: 'select',
                          sortable: true,
                          align: 'left'
                      },      
                      {
                          header: '잔액',
                          name: 'balancem',
                          sortable: true,
                          align: 'left'
                      },
                      {
                          header: '입금금액',
                          name: 'decreasePrice',
                          editor: 'text',
                          sortable: true,
                          align: 'left'
                      },
                      {
                        header: '채무상태',
                        name: 'state',
                        sortable: true,
                        align: 'left'
                      }
            ]
        });
        return makeGrid;
      }
      
      function makeBacctTabulatorGrid(accountList) {
        let makeBacctTabulator = new Tabulator("#example-table", {
          layout:"fitColumns",
          pagination:"local",
          data: accountList,
          paginationSize:8,
          movableColumns:true,
          paginationCounter:"rows",
          paginationCounter:function(pageSize, currentRow, currentPage, totalRows, totalPages){
              return "";
          },
          langs:{
              "default":{
                  "pagination":{
                      "first":"처음",
                      "first_title":"처음으로",
                      "last":"끝",
                      "last_title":"마지막으로",
                      "prev":"이전",
                      "prev_title":"이전으로",
                      "next":"다음",
                      "next_title":"다음으로",
                      "all":"전체",
                  }
              }
          },
          columns:[
              {title:"계좌코드", field:"bacctCode", visible:false},
              {title:"계좌번호", field:"bacctNo", width:220, sorter:"string", headerFilter:"input"},
              {title:"은행명", field:"bankName", width:220, sorter:"string", headerFilter:"input"},
              {title:"계좌명", field:"bacctName", width:330, sorter:"string", headerFilter:"input"},
          ],
        });
        return makeBacctTabulator;
      }
      
      function fetchClientCode(clientCode) {
        let clientData = {
          method: 'POST',
          body: JSON.stringify({"clientCode": clientCode}),
          headers: {
            'Content-Type' : 'application/json'
          }
        };
        fetch('/api/account/clientPayables', clientData)
        .then(result => result.json())
        .then(clientPayableList => {
          let ledgebody = document.querySelector('#ledgeBody');
          ledgebody.innerHTML = '';
          let layout = '';
          let tot = 0;
          let increaseTot = 0; // 증가금액 누계
          let decreaseTot = 0; // 감소금액 누계
          for (const ele of clientPayableList) {
            document.querySelector('#payClientName').innerHTML = `<strong>거래처:</strong> ${ele.clientName}`;
            increaseTot += ele.increasePrice;
            decreaseTot += ele.decreasePrice;
            tot += ele.increasePrice - ele.decreasePrice;
            layout +=  `<tr>
                            <td>${ele.recDate}</td> 
                            <td>${ele.acctName}</td>
                            <td>${ele.summary}</td>
                            <td>${ele.increasePrice}</td>
                            <td>${ele.decreasePrice}</td>
                            <td>${tot}</td>
                        </tr>`;
          }
          ledgebody.insertAdjacentHTML('beforeend', layout);
          document.querySelector('#totIncrease').innerHTML = increaseTot;
          document.querySelector('#totDecrease').innerHTML = decreaseTot;
          document.querySelector('#totBalance').innerHTML = increaseTot - decreaseTot;
        })
      }
      
      function fetchBacctList() {
        fetch('/api/account/bacct')
        .then(result => result.json())
        .then(accountList => {
          //Build Tabulator
          let accList = makeBacctTabulatorGrid(accountList);

          //#region 채무결제기능
          /**
           * 채무 결제를 위한 prettyalert
           * 
          */
          accList.on("rowClick", function(event, row) {
            Swal.fire({
              title: "결제하시겠습니까?",
              text: `계좌번호 : ${row.getData().bacctNo} 은행명: ${row.getData().bankName}`,
              icon: "warning",
              showCancelButton: true,
              confirmButtonColor: "#3085d6",
              cancelButtonColor: "#d33",
              confirmButtonText: "결제",
              cancelButtonText: "취소"
            })
            .then((result) => {
              if (result.isConfirmed) {
                Swal.fire({
                  title: "결제되었습니다",
                  text: `계좌번호 : ${row.getData().bacctNo} 결제완료`,
                  icon: "success",
                  confirmButtonText: "완료"
                })
                .then((result => {
                  if(result.isConfirmed) {
                    // 여기서 DB업데이트가 실행되어야함
                    // 채무거래 테이블
                    let payableList = grid.getCheckedRows(); // toast grid 체크목록 받아오는 함수 getCheckedRows()
                    console.log(grid.getCheckedRows());
                    let bacctInfo = row.getData();
                    let arr = {
                      payableList, bacctInfo
                    }
                    let payables = {
                      method: 'POST',
                      body: JSON.stringify(arr),
                      headers: {
                          'Content-Type' : 'application/json'
                      }
                    };
                    fetch('/account/insertPayablesBalance', payables)
                    .then(result => result.text())
                    .then(result => {
                      console.log(result);
                      if(result==='success') {
                      location.reload(true);
                      } else {
                        alert("결제가 취소되었습니다.")
                      }
                    })
                  }
                }))
              }
            });

          })
          //#endregion 채무결제기능
        })
      }
  

      //클라이언트별 총 채무 페이지
      fetch('/api/account/payables')
        .then(result => result.json())
        .then((result) => {
          grid = makePayableGrid(result);
          // 거래처의 채무 내역 출력하는 거래처 원장 모달
          grid.on('click', (event) => { // grid 클릭이벤트 발생
              if(event.columnName === 'clientCode' && event.rowKey>=0) {
                let ledgeModal = new bootstrap.Modal(document.querySelector('#ledgerModal'));
                let clientCode = grid.getValue(event.rowKey,"clientCode");

                fetchClientCode(clientCode);
                // 거래처 원장 모달
                ledgeModal.show();
              }
          })
          // 계좌 목록 조회 모달
          fetchBacctList();
      })
      .catch((error) => console.error("Error loading JSON:", error));

      // PDF 저장 기능
      document.getElementById('pdfButton').addEventListener('click', function() {
          const element = document.getElementById('reportContent');
          html2canvas(element).then(canvas => {
              const imgData = canvas.toDataURL('image/png');
              const pdf = new jspdf.jsPDF();
              const imgProps = pdf.getImageProperties(imgData);
              const pdfWidth = pdf.internal.pageSize.getWidth();
              const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
              pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
              pdf.save('거래처원장.pdf');
          });
      });
    })
    
  </script>
</body>
</html>