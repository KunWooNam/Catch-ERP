<!DOCTYPE html>

<html xmlns:th="https://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{common/layouts/sales_layout}"
      layout:fragment="Content">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>거래처 조회</title>
</head>
    <style>
        .price-input {
            position: relative;
        }

        .price-input::after {
            content: '원';
            position: absolute;
            right: 25px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .sort-icon {
            cursor: pointer;
            padding: 2px;
        }

        .sort-icon:hover {
            color: #0d6efd;
        }

        .list {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>
    <div class="bg-white shadow-sm rounded" style="padding: 20px;">
	    <!-- Search Section -->
	    <div class="border-bottom pb-3 mb-4">
	      <h2>거래처 리스트</h2>
	    </div>
	    <div class="gridWrapper">
	      <button type="button" class="btn btn-success" id="newAcc" data-bs-toggle="modal" data-bs-target="#insertClientModal" style="margin-bottom: 10px;">신규등록</button>
	      <div id="clientListGrid"></div>
	      <div id="pagination" class="tui-pagination"></div> <!-- 페이징 ui -->
	    </div>
        <!-- 거래처 등록 모달창 -->
        <div class="modal fade" id="insertClientModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <form method="post" th:action="@{/business/insertClient}" name="insertClientForm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="customerModalLabel">거래처등록</h5>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" id="customerTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab"
                                        data-bs-target="#basic" type="button" role="tab" aria-controls="basic"
                                        aria-selected="true">기본</button>
                                </li>
                            </ul>
                            <div class="tab-content mt-3" id="customerTabContent">
                                <!-- 기본 거래처 입력 내용 -->
                                <div class="tab-pane fade  show active" id="basic" role="tabpanel"
                                    aria-labelledby="basic-tab">
                                    <div class="mb-3 row">
                                        <label for="customerName" class="col-sm-3 col-form-label">상호(이름)</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="clientName" name="clientName" placeholder="상호(이름)" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="representativeName" class="col-sm-3 col-form-label">대표자명</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="ceoName" name="ceoName" placeholder="대표자명" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="industry" class="col-sm-3 col-form-label">업태</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="state" name="state" placeholder="업태" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="category" class="col-sm-3 col-form-label">종목</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="event" name="event" placeholder="종목" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="phone" class="col-sm-3 col-form-label">회사 전화</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" id="companyTel" name="companyTel" placeholder="회사 전화" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="phone" class="col-sm-3 col-form-label">거래 유형</label>
                                        <div class="col-sm-9">
                                            <select class="form-select form-control" id="tradeType" name="tradeType" >
                                                <option value="채무" selected>채무</option>
                                                <option value="채권">채권</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="fax" class="col-sm-3 col-form-label">Fax</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" id="fax" name="fax" placeholder="Fax" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="searchContents" class="col-sm-3 col-form-label">계좌</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="clientBacct" name="clientBacct" placeholder="계좌" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="zipCode" class="col-sm-3 col-form-label">우편번호</label>
                                        <div class="col-sm-9">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="sample6_postcode" name="zipcode" placeholder="우편번호">
                                                <button class="btn btn-outline-secondary" id="findZipCode" type="button">우편번호 검색</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="address" class="col-sm-3 col-form-label">주소</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="address" name="address" placeholder="주소" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="address2" class="col-sm-3 col-form-label">상세주소</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="detailAddress" name="detailAddress" placeholder="상세주소" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="manager" class="col-sm-3 col-form-label">담당자</label>
                                        <div class="col-sm-9">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="manager" name="manager" placeholder="담당자">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="mobilePhone" class="col-sm-3 col-form-label">담당자 연락처</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" id="employeeTel" name="employeeTel" placeholder="모바일" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="additional" role="tabpanel" aria-labelledby="additional-tab">
                                    <!-- 부가정보 탭 내용 -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">저장</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- 거래처 상세(수정) 모달창 -->
        <div class="modal fade" id="updateClientModal" tabindex="-1" aria-labelledby="customerModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <form method="post" th:action="@{/business/updateClient}" name="updateClientForm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="customerModalLabel">거래처상세(수정)</h5>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" id="customerTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="basic-tab" data-bs-toggle="tab"
                                        data-bs-target="#basic" type="button" role="tab" aria-controls="basic"
                                        aria-selected="true">기본</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="credit-price-tab" data-bs-toggle="tab"
                                        data-bs-target="#credit-price" type="button" role="tab" aria-controls="credit-price"
                                        aria-selected="false">품목</button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="additional-tab" data-bs-toggle="tab"
                                        data-bs-target="#additional" type="button" role="tab" aria-controls="additional"
                                        aria-selected="false">부가정보</button>
                                </li>
                            </ul>
                            <div class="tab-content mt-3" id="customerTabContent">
                                <!-- 기본 거래처 입력 내용 -->
                                <div class="tab-pane fade  show active" id="basic" role="tabpanel"
                                    aria-labelledby="basic-tab">
                                    <div class="mb-3 row">
                                        <label for="customerName" class="col-sm-3 col-form-label">상호(이름)</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="clientName" name="clientName" placeholder="상호(이름)" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="representativeName" class="col-sm-3 col-form-label">대표자명</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="ceoName" name="ceoName" placeholder="대표자명" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="industry" class="col-sm-3 col-form-label">업태</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="state" name="state" placeholder="업태" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="category" class="col-sm-3 col-form-label">종목</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="event" name="event" placeholder="종목" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="phone" class="col-sm-3 col-form-label">회사 전화</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" id="employeeTel" name="employeeTel" placeholder="회사 전화" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="phone" class="col-sm-3 col-form-label">거래 유형</label>
                                        <div class="col-sm-9">
                                            <select class="form-select form-control" id="tradeType" name="tradeType" >
                                                <option value="채무" selected>채무</option>
                                                <option value="채권">채권</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="fax" class="col-sm-3 col-form-label">Fax</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" id="fax" name="fax" placeholder="Fax" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="searchContents" class="col-sm-3 col-form-label">계좌</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="clientBacct" name="clientBacct" placeholder="계좌" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="mobilePhone" class="col-sm-3 col-form-label">모바일</label>
                                        <div class="col-sm-9">
                                            <input type="tel" class="form-control" id="mobilePhone" name="mobilePhone" placeholder="모바일" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="zipCode" class="col-sm-3 col-form-label">우편번호</label>
                                        <div class="col-sm-9">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="sample6_postcode" name="zipcode" placeholder="우편번호">
                                                <button class="btn btn-outline-secondary" id="findZipCode" type="button">우편번호 검색</button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="address" class="col-sm-3 col-form-label">주소</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="address" name="address" placeholder="주소" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="address2" class="col-sm-3 col-form-label">상세주소</label>
                                        <div class="col-sm-9">
                                            <input type="text" class="form-control" id="detailAddress" name="detailAddress" placeholder="상세주소" required>
                                        </div>
                                    </div>
                                    <div class="mb-3 row">
                                        <label for="manager" class="col-sm-3 col-form-label">담당자</label>
                                        <div class="col-sm-9">
                                            <div class="input-group">
                                                <input type="text" class="form-control" id="manager" name="employeeName" placeholder="담당자">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="tab-pane fade" id="additional" role="tabpanel" aria-labelledby="additional-tab">
                                    <!-- 부가정보 탭 내용 -->
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success">수정</button>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        let grid;
        // 거래처 상세 모달
        let clientDetailModal = new bootstrap.Modal(document.querySelector('#updateClientModal'));
        function makeClientToastGrid(clientList) {
            let grid = new tui.Grid( { // 브라우저 환경에서 네임 스페이스 이용(new tui.Grid)
            el: document.querySelector('#clientListGrid'),
            data: clientList, // toast ui table 에 입력할 데이터값
            scrollX: true,
            scrollY: true, // 가로, 세로 스크롤 사용 유무 판단
            pageOptions: {
                useClient: true,
                perPage: 13
            },
            columns: [
                        {
                            header: '거래처코드',
                            name: 'clientCode',
                            sortable: true,
                            filter: 'select',
                            align: 'center',
                            hidden: true
                        },
                        {
                            header: '거래처명',
                            name: 'clientName',
                            filter: 'select',
                            sortable: true,
                            align: 'left'
                        },
                        {
                            header: '대표자명',
                            name: 'ceoName',
                            sortable: true,
                            align: 'left'
                        },      
                        {
                            header: '거래유형',
                            name: 'tradeType',
                            filter: 'select',
                            sortable: true,
                            align: 'left'
                        },
                        {
                            header: '팩스',
                            name: 'fax',
                            sortable: true,
                            align: 'left'
                        },
                        {
                            header: '거래처 계좌',
                            name: 'clientBacct',
                            sortable: true,
                            align: 'left'
                        },
                        {
                            header: '업태',
                            name: 'state',
                            sortable: true,
                            align: 'left'
                        },
                    ],
            });                                                                                                                                                                                                                                                      
            return grid;
        }

        function makeClientListTabulator(clientList) {
            let grid = new Tabulator("#tabulatorGrid", {
            layout:"fitColumns",
            pagination:"local",
            data: clientList,
            paginationSize:12,
            movableColumns:true,
            paginationCounter:"rows",
            resizableColumnFit:true,
            paginationCounter:function(pageSize, currentRow, currentPage, totalRows, totalPages){
                return "등록된 거래처 : "+totalRows+"개";
            },
            rowFormatter:function(row){
                row.getElement().classList.add(".table-light"); //mark rows with age greater than or equal to 18 as successful;
            },
            langs:{
                "default":{
                    "pagination":{
                        "first":"처음",
                        "first_title":"처음으로",
                        "last":"끝",
                        "last_title":"마지막으로",
                        "prev":"이전",
                        "prev_title":"이전으로",
                        "next":"다음",
                        "next_title":"다음으로",
                        "all":"전체",
                    }
                }
            },
            columns:[
                {title:"거래처코드", field:"clientCode", width:150, sorter:"string", headerFilter:"input"},
                {title:"거래처명", field:"clientName", width:200, sorter:"string", headerFilter:"input"},
                {title:"거래유형", field:"tradeType", width:120, sorter:"string", headerFilter:"input"},
                {title:"연락처", field:"companyTel", width:200, sorter:"string", headerFilter:"input"},
                {title:"주소", field:"address", width:400, sorter:"string", headerFilter:"input"},
                {title:"적요", field:"summary", width:470, sorter:"string", headerFilter:"input"},
            ],
            });
            return grid;
        }
        
        function telValidChk(tel) {
            if(pattern.test(tel) === false) { return false; }
            else { return true; }
        }
        
        function fetchClientCode(clientCode) {
            console.log(clientCode);
            fetch('/api/business/clientDetail/' + clientCode)
            .then(result => result.json())
            .then(clientInfo => {
                //#region 상세 정보창의 input => value 에 들어갈 클라이언트 정보들
                /**
                 * @ clientName / ceoName / state / event / employeeTel / tradeType
                 * @ fax / clientBacct / mobilePhone / address / detailAddress / managerName
                */
                document.updateClientForm.querySelector('#clientName').value = clientInfo.clientName;
                document.updateClientForm.querySelector('#ceoName').value = clientInfo.ceoName;
                document.updateClientForm.querySelector('#state').value = clientInfo.state;
                document.updateClientForm.querySelector('#event').value = clientInfo.event;
                document.updateClientForm.querySelector('#companyTel').value = clientInfo.companyTel;
                document.updateClientForm.querySelector('#tradeType').value = clientInfo.tradeType;
                document.updateClientForm.querySelector('#fax').value = clientInfo.fax;
                document.updateClientForm.querySelector('#clientBacct').value = clientInfo.clientBacct;
                document.updateClientForm.querySelector('#sample6_postcode').value = clientInfo.zipCode;
                document.updateClientForm.querySelector('#address').value = clientInfo.address;
                document.updateClientForm.querySelector('#detailAddress').value = clientInfo.detailAddress;
                document.updateClientForm.querySelector('#manager').value = clientInfo.employeeName;
                document.updateClientForm.querySelector('#employeeTel').value = clientInfo.employeeTel;
                //#endregion
            });

            
        }
        document.addEventListener('DOMContentLoaded', function () {
            // 우편번호 검색
            document.querySelector('#findZipCode').addEventListener('click', function () {
                new daum.Postcode({
                    oncomplete: function(data) {
                        // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

                        // 각 주소의 노출 규칙에 따라 주소를 조합한다.
                        // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
                        var addr = ''; // 주소 변수
                        var extraAddr = ''; // 참고항목 변수

                        //사용자가 선택한 주소 타입에 따라 해당 주소 값을 가져온다.
                        if (data.userSelectedType === 'R') { // 사용자가 도로명 주소를 선택했을 경우
                            addr = data.roadAddress;
                        } else { // 사용자가 지번 주소를 선택했을 경우(J)
                            addr = data.jibunAddress;
                        }

                        // 사용자가 선택한 주소가 도로명 타입일때 참고항목을 조합한다.
                        if(data.userSelectedType === 'R'){
                            // 법정동명이 있을 경우 추가한다. (법정리는 제외)
                            // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
                            if(data.bname !== '' && /[동|로|가]$/g.test(data.bname)){
                                extraAddr += data.bname;
                            }
                            // 건물명이 있고, 공동주택일 경우 추가한다.
                            if(data.buildingName !== '' && data.apartment === 'Y'){
                                extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                            }
                            // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
                            if(extraAddr !== ''){
                                extraAddr = ' (' + extraAddr + ')';
                            }
                            // 조합된 참고항목을 해당 필드에 넣는다.
                            document.getElementById("detailAddress").value = extraAddr;
                        
                        } else {
                            document.getElementById("detailAddress").value = '';
                        }

                        // 우편번호와 주소 정보를 해당 필드에 넣는다.
                        document.getElementById('sample6_postcode').value = data.zonecode;
                        document.getElementById("address").value = addr;
                        // 커서를 상세주소 필드로 이동한다.
                        document.getElementById("detailAddress").focus();
                    }
                }).open();
            }) 

            // 유효성 검사
            function validation() {
                /**
                 * @을 기준으로 앞 구간이 알파벳 or 숫자 조합으로 이루어져 있는지 체크
                 * @을 기준으로 뒷 구간이 알파벳 or 숫자 조합으로 이루어져 있는지 체크
                 * @을 기준으로 뒷 구간에서 . 뒷 구간이 알파벳 or 숫자 조합으로 이루어져 있는지 체크
                */
                const emailPattern = /^[A-Za-z0-9_\.\-]+@[A-Za-z0-9\-]+\.[A-za-z0-9\-]+/;
                /**
                 * -(하이픈)을 기준으로 첫번째 구간이 01[0,1,6,7,8,9](핸드폰), 02(집), 030~099(지역) 중 하나인지 체크
                 * -(하이픈)을 기준으로 두번째 구간이 숫자 3~4 자리로 이루어져 있는지 체크
                 * -(하이픈)을 기준으로 세번째 구간이 숫자 4자리로 이루어져 있는지 체크
                */
                const telPattern = /^(01[016789]{1}|02|0[3-9]{1}[0-9]{1})-?[0-9]{3,4}-?[0-9]{4}$/;

                
                let email = document.querySelector('#email').value();
                let companyTel = document.querySelector('#employeeTel').value();
                let clientTel = document.querySelector('#employeeTel').value();

                if(telValidChk(companyTel) == false || telValidChk(clientTel)) {
                    alert('올바른 전화번호 형식이 아닙니다.')
                    return;
                }
            }

            fetch('/api/business/client')
            .then(result => result.json())
            .then(clientList => {
                console.log(clientList)
                grid = makeClientToastGrid(clientList);
                grid.on('click', (event) => { // grid 클릭이벤트 발생
                    if(event.columnName === 'clientName' && event.rowKey>=0) {
                        let clientCode = grid.getValue(event.rowKey,"clientCode");
                        // 거래처 상세 조회 모달
                        fetchClientCode(clientCode);
                        // 거래처 원장 모달
                        clientDetailModal.show();
                    }
                })
                //makeClientListTabulator(clientList);
            });

            var saveButton = document.getElementById('saveButton');
            saveButton.addEventListener('click', function () {
                // 저장 로직을 여기에 구현
                console.log('저장 버튼이 클릭되었습니다.');
            });

            document.addEventListener('keydown', function (event) {
                if (event.key === 'F8') {
                    event.preventDefault();
                    saveButton.click();
                }
            });
        });

        
    </script>

</body>

</html>